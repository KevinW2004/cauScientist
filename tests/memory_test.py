import sys
sys.path.append("./src")
from memory import MemoryService

def test_memory_module():
    print("ðŸš€ Starting Memory Module Test...")

    # 1. åˆå§‹åŒ–
    memory = MemoryService()

    # 2. å‡†å¤‡æµ‹è¯•æ•°æ® (æ¨¡æ‹Ÿç§‘å­¦æ–‡çŒ®å’Œåæ€)
    reflection_text = "Analysis Failed: The causal graph generated by PC algorithm was cyclical, which violates the DAG assumption. I need to check the data preprocessing step."
    paper_text = "The PC algorithm assumes that the underlying causal structure is a Directed Acyclic Graph (DAG). It uses conditional independence tests."

    # 3. å­˜å‚¨æ•°æ® (å¸¦æœ‰ Metadata)
    print("\nðŸ“¥ Inserting memories...")
    memory.save_memory(
        reflection_text, metadata={"type": "reflection", "status": "failed"}
    )
    memory.save_memory(
        paper_text, metadata={"type": "knowledge", "topic": "PC_algorithm"}
    )

    # 4. æ£€ç´¢æµ‹è¯•
    query = "Why did the causal discovery fail?"
    print(f"\nðŸ” Querying: '{query}'")

    results = memory.retrieve_memories(query, limit=2)

    # 5. éªŒè¯ç»“æžœ
    for i, res in enumerate(results):
        print(f"--- Result {i+1} (Score: {res['score']:.4f}) ---")
        print(f"Content: {res['text']}")
        print(f"Metadata: {res['metadata']}")

    # ç®€å•çš„æ–­è¨€
    assert len(results) > 0
    assert "cyclical" in results[0]["text"] or "cyclical" in results[1]["text"]
    print("\nâœ… Test Passed!")


if __name__ == "__main__":
    test_memory_module()
